

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auto-alignment &mdash; ibex_bluesky_core 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=dc476284" />

  
    <link rel="shortcut icon" href="../../_static/favicon.svg"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Detector-mapping alignment" href="detector_mapping_alignment.html" />
    <link rel="prev" title="Reflectometry-specific Plans" href="../reflectometry.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ibex_bluesky_core
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/overview.html">Getting started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../devices/blocks.html">Blocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devices/dae.html">DAE (Data Acquisition Electronics)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Callbacks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../callbacks/isiscallbacks.html">ISIS Standard Callbacks (<code class="xref py py-obj docutils literal notranslate"><span class="pre">ISISCallbacks</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../callbacks/fitting.html">Fits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../callbacks/centre_of_mass.html">Centre of Mass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../callbacks/plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../callbacks/file_writing.html">File writing callbacks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plans</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../plans.html">General Plans</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../reflectometry.html">Reflectometry-specific Plans</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Auto-alignment</a></li>
<li class="toctree-l2"><a class="reference internal" href="detector_mapping_alignment.html">Detector-mapping alignment</a></li>
<li class="toctree-l2"><a class="reference internal" href="psi_scan_linear_detector.html">Psi scanning</a></li>
<li class="toctree-l2"><a class="reference internal" href="refl_param_scan.html">Reflectometry parameter scans</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plan stubs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../plan_stubs/external_code.html">Calling external code (<code class="xref py py-obj docutils literal notranslate"><span class="pre">call_sync</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plan_stubs/matplotlib_helpers.html">Matplotlib helpers (<code class="xref py py-obj docutils literal notranslate"><span class="pre">call_qt_aware</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plan_stubs/plan_wrappers.html">Plan wrappers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plan_stubs/polling.html">Continuous polling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plan_stubs/redefining.html">Redefinition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plan_stubs/user_input.html">User input helpers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../replotting_scans.html">Replaying documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architectural_decisions.html">Architectural Decisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_information.html">Developer Information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ibex_bluesky_core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../reflectometry.html">Reflectometry-specific Plans</a></li>
      <li class="breadcrumb-item active">Auto-alignment</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ISISComputingGroup/ibex_bluesky_core/blob/main/doc/plans/reflectometry/autoalign.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="auto-alignment">
<h1>Auto-alignment<a class="headerlink" href="#auto-alignment" title="Link to this heading"></a></h1>
<p>For reflectometers, we provide a few generic plans which can be used as helpers for automated beamline alignment.</p>
<p>The <a class="reference internal" href="../../generated/ibex_bluesky_core.plans.reflectometry.html#ibex_bluesky_core.plans.reflectometry.optimise_axis_against_intensity" title="ibex_bluesky_core.plans.reflectometry.optimise_axis_against_intensity"><code class="xref py py-obj docutils literal notranslate"><span class="pre">optimise_axis_against_intensity</span></code></a> plan is designed to scan a <a class="reference external" href="https://blueskyproject.io/bluesky/main/hardware.html#bluesky.protocols.Movable" title="(in bluesky v1.14.7.dev29+gfb2c32466)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Movable</span></code></a> against beam intensity, and given a fitting routine, will aim to find an optimum value. <a class="reference internal" href="../../callbacks/fitting/standard_fits.html"><span class="std std-doc">Standard fits</span></a> have been implemented and can be used easily, or custom fits can also be used.</p>
<p>Once a fit has been performed, <a class="reference internal" href="../../generated/ibex_bluesky_core.plans.reflectometry.html#ibex_bluesky_core.plans.reflectometry.optimise_axis_against_intensity" title="ibex_bluesky_core.plans.reflectometry.optimise_axis_against_intensity"><code class="xref py py-obj docutils literal notranslate"><span class="pre">optimise_axis_against_intensity</span></code></a> will check that the fit parameters are ‘sensible’ - there are some default checks, but the user is encouraged to provide their own checks. If the checks pass, the motor will be moved to the fit value, otherwise it will run a user-provided callback, and then ask the user if they want to rescan or move anyway.</p>
<p>Reflectometer auto-alignment routines will generally be structured as a series of calls which:</p>
<ul class="simple">
<li><p>Put the beamline into a suitable state for the alignment</p></li>
<li><p>Call <a class="reference internal" href="../../generated/ibex_bluesky_core.plans.reflectometry.html#ibex_bluesky_core.plans.reflectometry.optimise_axis_against_intensity" title="ibex_bluesky_core.plans.reflectometry.optimise_axis_against_intensity"><code class="xref py py-obj docutils literal notranslate"><span class="pre">optimise_axis_against_intensity</span></code></a> to optimise the axis. This will leave the axis parked at its optimal position.</p></li>
<li><p>Redefine that position as zero (note: this is fully optional, but common on reflectometers)</p></li>
<li><p>Repeat the above steps for subsequent axes</p></li>
</ul>
<p>For example, using a reflectometry parameter as your <a class="reference external" href="https://blueskyproject.io/bluesky/main/hardware.html#bluesky.protocols.Movable" title="(in bluesky v1.14.7.dev29+gfb2c32466)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Movable</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">full_autoalign_plan</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
 
    <span class="n">det_pixels</span> <span class="o">=</span> <span class="n">centred_pixel</span><span class="p">(</span><span class="n">DEFAULT_DET</span><span class="p">,</span> <span class="n">PIXEL_RANGE</span><span class="p">)</span>
    <span class="n">dae</span> <span class="o">=</span> <span class="n">monitor_normalising_dae</span><span class="p">(</span>
        <span class="n">det_pixels</span><span class="o">=</span><span class="n">det_pixels</span><span class="p">,</span>
        <span class="n">frames</span><span class="o">=</span><span class="n">FRAMES</span><span class="p">,</span>
        <span class="n">periods</span><span class="o">=</span><span class="n">PERIODS</span><span class="p">,</span>
        <span class="n">save_run</span><span class="o">=</span><span class="n">SAVE_RUN</span><span class="p">,</span>
        <span class="n">monitor</span><span class="o">=</span><span class="n">DEFAULT_MON</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Interfaces with the reflectometry server</span>
    <span class="n">s1vg</span> <span class="o">=</span> <span class="n">ReflParameter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">PREFIX</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;S1VG&quot;</span><span class="p">,</span> <span class="n">changing_timeout_s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

    <span class="k">yield from</span> <span class="n">ensure_connected</span><span class="p">(</span><span class="n">s1vg</span><span class="p">,</span> <span class="n">dae</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting auto-alignment...&quot;</span><span class="p">)</span>

    <span class="c1"># S1VG</span>

    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">s1vg</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">optimise_axis_against_intensity</span><span class="p">(</span>
        <span class="n">dae</span><span class="o">=</span><span class="n">dae</span><span class="p">,</span>
        <span class="n">alignment_param</span><span class="o">=</span><span class="n">s1vg</span><span class="p">,</span>
        <span class="n">fit_method</span><span class="o">=</span><span class="n">SlitScan</span><span class="o">.</span><span class="n">fit</span><span class="p">(),</span> <span class="c1"># What form of data do you expect</span>
        <span class="n">fit_param</span><span class="o">=</span><span class="s2">&quot;inflection0&quot;</span><span class="p">,</span> <span class="c1"># Which fitting parameter do you want to optimise</span>
        <span class="n">rel_scan_ranges</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span> <span class="c1"># Scan with range of 0.3, then 0.05</span>
        <span class="n">num_points</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># Number of points in a scan.</span>
    <span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">s1vg</span><span class="o">.</span><span class="n">redefine</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Redefine current motor position to be 0</span>

    <span class="c1"># Other params</span>
    <span class="c1"># ....</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Auto alignment complete.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>As mentioned prior, it is recommended that for each <a class="reference external" href="https://blueskyproject.io/bluesky/main/hardware.html#bluesky.protocols.Movable" title="(in bluesky v1.14.7.dev29+gfb2c32466)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Movable</span></code></a> to be aligned, you should provide a checking function, to make sure that for the value you receive for the chosen fitting parameter e.g centre of a Gaussian, is physically reasonable. If the optimised value fails the check, then you will have the option to either restart the alignment for this axis, or continue moving this axis to the located value despite the failing check.</p>
<p>The following is how you would define a check function and pass it to <a class="reference internal" href="../../generated/ibex_bluesky_core.plans.reflectometry.html#ibex_bluesky_core.plans.reflectometry.optimise_axis_against_intensity" title="ibex_bluesky_core.plans.reflectometry.optimise_axis_against_intensity"><code class="xref py py-obj docutils literal notranslate"><span class="pre">optimise_axis_against_intensity</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">lmfit.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">isclose</span>


<span class="k">def</span><span class="w"> </span><span class="nf">s1vg_checks</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">ModelResult</span><span class="p">,</span> <span class="n">alignment_param_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Must take a ModelResult and a float</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check for optimised S1VG value. Returns True if sensible.&quot;&quot;&quot;</span>
    <span class="n">rsquared_confidence</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">expected_param_value</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">expected_param_value_tol</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">max_peak_factor</span> <span class="o">=</span> <span class="mf">5.0</span>

    <span class="c1"># Check that r-squared is above a tolerance</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">rsquared</span> <span class="o">&lt;</span> <span class="n">rsquared_confidence</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;R-squared below confidence level.&quot;</span>

    <span class="c1"># For S1VG, provide a value you would expect for it,</span>
    <span class="c1"># assert if its not close by a provided factor</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isclose</span><span class="p">(</span><span class="n">expected_param_value</span><span class="p">,</span> <span class="n">alignment_param_value</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="n">expected_param_value_tol</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Optimised value is not close to expected value.&quot;</span>

    <span class="c1"># Is the peak above the background by some factor (optional because param may not be for</span>
    <span class="c1"># a peak, or background may not be a parameter in the model).</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">result</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">alignment_param_value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_peak_factor</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Peak was not above the background by factor.&quot;</span>
    
    <span class="c1"># Everything is fine, so return None</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">optimise_axis_against_intensity</span><span class="p">(</span>
        <span class="n">dae</span><span class="o">=</span><span class="n">dae</span><span class="p">,</span>
        <span class="n">alignment_param</span><span class="o">=</span><span class="n">s1vg</span><span class="p">,</span>
        <span class="n">fit_method</span><span class="o">=</span><span class="n">SlitScan</span><span class="o">.</span><span class="n">fit</span><span class="p">(),</span>
        <span class="n">fit_param</span><span class="o">=</span><span class="s2">&quot;inflection0&quot;</span><span class="p">,</span>
        <span class="n">rel_scan_ranges</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span> <span class="c1"># Scan with range of 0.3, then 0.05</span>
        <span class="n">num_points</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">is_good_fit</span><span class="o">=</span><span class="n">s1vg_checks</span> <span class="c1"># Pass s1vg_checks</span>
    <span class="p">)</span>

</pre></div>
</div>
<p>To determine what to do in the event of a value being “invalid” you can use a plan like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ibex_bluesky_core.plans.reflectometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">optimise_axis_against_intensity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ibex_bluesky_core.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">SlitScan</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Msg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.plan_stubs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bps</span>


<span class="k">def</span><span class="w"> </span><span class="nf">problem_found_plan</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="c1"># This must be a plan, if it doesn&#39;t otherwise yield, make it a plan</span>
    <span class="c1"># by yielding from bps.null()</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">null</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There was a problem - oh no!&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">optimise_axis_against_intensity</span><span class="p">(</span>
        <span class="n">dae</span><span class="o">=</span><span class="n">dae</span><span class="p">,</span>
        <span class="n">alignment_param</span><span class="o">=</span><span class="n">s1vg</span><span class="p">,</span>
        <span class="n">fit_method</span><span class="o">=</span><span class="n">SlitScan</span><span class="o">.</span><span class="n">fit</span><span class="p">(),</span>
        <span class="n">fit_param</span><span class="o">=</span><span class="s2">&quot;inflection0&quot;</span><span class="p">,</span>
        <span class="n">rel_scan_ranges</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">],</span>
        <span class="n">num_points</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Fit will never converge with just 1 point which should cause a &quot;problem&quot;.</span>
        <span class="n">problem_found_plan</span><span class="o">=</span><span class="n">problem_found_plan</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../reflectometry.html" class="btn btn-neutral float-left" title="Reflectometry-specific Plans" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="detector_mapping_alignment.html" class="btn btn-neutral float-right" title="Detector-mapping alignment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>