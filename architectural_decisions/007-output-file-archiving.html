

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>7. Output file archiving &mdash; ibex_bluesky_core 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=dc476284" />

  
    <link rel="shortcut icon" href="../_static/favicon.svg"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";





const initStyles = () => {
    const defaultStyle = document.createElement('style');
    defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}`;
    document.head.appendChild(defaultStyle);

    const fullscreenStyle = document.createElement('style');
    fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
    document.head.appendChild(fullscreenStyle);
}

// Detect if page has dark background
const isDarkTheme = () => {
    // We use a set of heuristics:
    // 1. Check for common dark mode classes or attributes
    // 2. Check computed background color brightness
    if (document.documentElement.classList.contains('dark') ||
        document.documentElement.getAttribute('data-theme') === 'dark' ||
        document.body.classList.contains('dark') ||
        document.body.getAttribute('data-theme') === 'dark') {
        // console.log("Dark theme detected via class/attribute");
        return true;
    }
    if (document.documentElement.classList.contains('light') ||
        document.documentElement.getAttribute('data-theme') === 'light' ||
        document.body.classList.contains('light') ||
        document.body.getAttribute('data-theme') === 'light') {
        // console.log("Light theme detected via class/attribute");
        return false;
    }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // console.log("Dark theme detected via prefers-color-scheme");
        return true;
    }
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        // console.log("Background color brightness:", brightness);
        return brightness < 128;
    }
    // console.log("No dark or light theme detected, defaulting to light theme");
    return false;
};

let darkTheme = isDarkTheme();
let modal = null;
let modalContent = null;
let previousScrollOffset = [window.scrollX, window.scrollY];

const runMermaid = async (rerun) => {
    console.log("Running mermaid diagrams, rerun =", rerun);
    // clear all existing mermaid charts
    let all_mermaids = document.querySelectorAll(".mermaid");

    if (rerun) {
        all_mermaids.forEach((el) => {
            if(!el.hasAttribute("data-original-code")) {
                // store original code
                // console.log(`Storing original code for first run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
            if(el.getAttribute("data-processed") === "true") {
                // remove and restore original
                el.removeAttribute("data-processed");
                // console.log(`Restoring original code for re-run: `, el.getAttribute('data-original-code'));
                el.innerHTML = el.getAttribute('data-original-code');
            } else {
                // store original code
                // console.log(`Storing original code for re-run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
        });
        await mermaid.run();
    }

    all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("True" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll(".mermaid svg");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(() => runMermaid(false), 200);
        return;
    }

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    if (modal !== null ) {
        // Destroy existing modal
        modal.remove();
        modal = null;
        modalContent = null;
    }

    modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            // Already processed, adjust button class if needed
            const existingBtn = mermaidDiv.parentNode.querySelector('.mermaid-fullscreen-btn');
            if (existingBtn) {
                existingBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
            }
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("True" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        container.appendChild(fullscreenBtn);
    });
};

const load = async () => {
    initStyles();

    await runMermaid(true);

    const reRunIfThemeChanges = async () => {
        const newDarkTheme = isDarkTheme();
        if (newDarkTheme !== darkTheme) {
            darkTheme = newDarkTheme;
            console.log("Theme change detected, re-running mermaid with", darkTheme ? "dark" : "default", "theme");
            await mermaid.initialize(
                {...JSON.parse(
                    `{"startOnLoad": false}`
                ),
                ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
                }
            );
            await runMermaid(true);
        }
    };

    // Update theme classes when theme changes
    const themeObserver = new MutationObserver(reRunIfThemeChanges);
    themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    themeObserver.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
};





console.log("Initializing mermaid with", darkTheme ? "dark" : "default", "theme");
mermaid.initialize(
    {...JSON.parse(
        `{"startOnLoad": false}`
    ),
    ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
    }
);

window.addEventListener("load", load);</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8. Using our own Centre of Mass Callback" href="008-centre-of-mass.html" />
    <link rel="prev" title="6. Where to put code" href="006-where-to-put-code.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >

          
          
          <a href="../index.html" class="icon icon-home">
            ibex_bluesky_core
              <img src="../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/overview.html">Getting started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../devices/blocks.html">Blocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devices/dae.html">DAE (Data Acquisition Electronics)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Callbacks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../callbacks/isiscallbacks.html">ISIS Standard Callbacks (<code class="xref py py-obj docutils literal notranslate"><span class="pre">ISISCallbacks</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../callbacks/fitting.html">Fits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../callbacks/centre_of_mass.html">Centre of Mass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../callbacks/plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../callbacks/file_writing.html">File writing callbacks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plans</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plans/plans.html">General Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plans/reflectometry.html">Reflectometry-specific Plans</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plan stubs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plan_stubs/external_code.html">Calling external code (<code class="xref py py-obj docutils literal notranslate"><span class="pre">call_sync</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plan_stubs/matplotlib_helpers.html">Matplotlib helpers (<code class="xref py py-obj docutils literal notranslate"><span class="pre">call_qt_aware</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plan_stubs/plan_wrappers.html">Plan wrappers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plan_stubs/polling.html">Continuous polling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plan_stubs/redefining.html">Redefinition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plan_stubs/user_input.html">User input helpers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../_api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../replotting_scans.html">Replaying documents</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../architectural_decisions.html">Architectural Decisions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="001-repo-structure.html">1. Repository structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="002-use-ophyd-async.html">2. Use <code class="docutils literal notranslate"><span class="pre">ophyd-async</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="003-run-in-process.html">3. Run in-process</a></li>
<li class="toctree-l2"><a class="reference internal" href="004-use-scipp.html">4. Use <code class="docutils literal notranslate"><span class="pre">scipp</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="005-variance-addition.html">5. Variance addition to counts data</a></li>
<li class="toctree-l2"><a class="reference internal" href="006-where-to-put-code.html">6. Where to put code</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7. Output file archiving</a></li>
<li class="toctree-l2"><a class="reference internal" href="008-centre-of-mass.html">8. Using our own Centre of Mass Callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="009-kafka-streaming.html">9. Kafka streaming</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developer_information.html">Developer Information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ibex_bluesky_core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../architectural_decisions.html">Architectural Decisions</a></li>
      <li class="breadcrumb-item active">7. Output file archiving</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ISISComputingGroup/ibex_bluesky_core/blob/main/doc/architectural_decisions/007-output-file-archiving.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="output-file-archiving">
<h1>7. Output file archiving<a class="headerlink" href="#output-file-archiving" title="Link to this heading"></a></h1>
<section id="status">
<h2>Status<a class="headerlink" href="#status" title="Link to this heading"></a></h2>
<p>Accepted</p>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Link to this heading"></a></h2>
<p>Our bluesky implementation contains bluesky callbacks which produce scientist-facing output files, for example:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../callbacks/file_writing.html"><span class="doc std std-doc">Human-readable scan result files</span></a>: <a class="reference internal" href="../generated/ibex_bluesky_core.callbacks.html#ibex_bluesky_core.callbacks.HumanReadableFileCallback" title="ibex_bluesky_core.callbacks.HumanReadableFileCallback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">HumanReadableFileCallback</span></code></a></p></li>
<li><p><a class="reference internal" href="../callbacks/fitting/livefit_logger.html"><span class="doc std std-doc">Fitting results</span></a>: <a class="reference internal" href="../generated/ibex_bluesky_core.callbacks.html#ibex_bluesky_core.callbacks.LiveFitLogger" title="ibex_bluesky_core.callbacks.LiveFitLogger"><code class="xref py py-obj docutils literal notranslate"><span class="pre">LiveFitLogger</span></code></a></p></li>
<li><p><a class="reference internal" href="../callbacks/plotting.html#plot-png-saver"><span class="std std-ref">Plot PNGs</span></a>: <a class="reference internal" href="../generated/ibex_bluesky_core.callbacks.html#ibex_bluesky_core.callbacks.PlotPNGSaver" title="ibex_bluesky_core.callbacks.PlotPNGSaver"><code class="xref py py-obj docutils literal notranslate"><span class="pre">PlotPNGSaver</span></code></a></p></li>
</ul>
<p>In addition, we have a <a class="reference internal" href="../callbacks/file_writing.html#event-doc-cb"><span class="std std-ref">developer-facing callback for diagnostics</span></a>,
<a class="reference internal" href="../generated/ibex_bluesky_core.callbacks.html#ibex_bluesky_core.callbacks.DocLoggingCallback" title="ibex_bluesky_core.callbacks.DocLoggingCallback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">DocLoggingCallback</span></code></a>.</p>
<p>The above callbacks produce files on disk in response to a bluesky scan. These files contain valuable data and so we
need to consider how these files are archived for the long term. This must align with the
<a class="reference external" href="https://www.isis.stfc.ac.uk/pages/data-policy.aspx">ISIS Data Policy</a>. We should make an attempt to align with
<a class="reference external" href="https://www.go-fair.org/fair-principles/">FAIR principles</a>.</p>
<p>According to the definitions in the <a class="reference external" href="https://www.isis.stfc.ac.uk/pages/data-policy.aspx">ISIS Data Policy</a>, the data
generated by bluesky is generally either “facility generated reduced data” or “metadata”.</p>
<p>This ADR is concerned with the location in which these bluesky output files are stored, and the archiving infrastructure
which is therefore used to keep these files for the long term.</p>
<hr class="docutils" />
<p>At the time of writing this ADR, in June 2025, the scientist-facing files are being written to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...\inst$\&lt;instrument&gt;\user\bluesky_scans\&lt;rb_number&gt;\
</pre></div>
</div>
<p>This location has some disadvantages:</p>
<ul class="simple">
<li><p>It is a network location, which means that a site network break will cause bluesky scans to fail to run</p></li>
<li><p>It is not a location designed for long-term scientifically useful data - for example in terms of data integrity</p></li>
<li><p>It is not necessarily accessible from downstream systems such as Topcat</p></li>
</ul>
<p>Therefore, we would like to define a different, more suitable, location into which bluesky output files can be written.</p>
<hr class="docutils" />
<p>Some representative use-cases are presented below, showing how data is expected to be used by scientists (click to
expand each use case):</p>
<details>
<summary>1 Bluesky scan, no neutron runs (e.g. scanning against a block)</summary>
<pre  class="mermaid">
        sequenceDiagram
actor PI
participant NDX
participant Archive
participant TopCat
note over PI:Start of RBNumber experiment
PI -&gt;&gt; NDX: Start bluesky scan
note over PI: Time Passes
note over NDX: Bluesky scan ends
note over NDX: creates scan.ascii and scan.nxs
NDX -&gt;&gt; Archive: Sends scan.ascii and scan.nxs
TopCat -&gt;&gt; Archive: Collects scan.ascii and scan.nxs
note over PI: 5 months later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to scan.ascii and scan.nxs
note over PI: 1 year later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to scan.nxs
    </pre></details>
<details>
<summary>1 Bluesky scan, aborted neutron runs</summary>
<pre  class="mermaid">
        sequenceDiagram
actor PI
participant NDX
participant Archive
participant TopCat as Online Catalogue
note over PI:Start of RBNumber experiment
PI -&gt;&gt; NDX: Start bluesky scan
note over NDX: DAE run started by scan &lt;br/&gt; Time passes &lt;br/&gt; Required data gathered in scan documents &lt;br/&gt; Abort DAE run
note over NDX: DAE run started by scan &lt;br/&gt; Time passes &lt;br/&gt; Required data gathered in scan documents &lt;br/&gt; Abort DAE run
note over NDX: DAE run started by scan &lt;br/&gt; Time passes &lt;br/&gt; Required data gathered in scan documents &lt;br/&gt; Abort DAE run
note over NDX: Bluesky scan ends
note over NDX: creates scan.ascii and scan.nxs
NDX -&gt;&gt; Archive: Sends scan.ascii and scan.nxs
TopCat -&gt;&gt; Archive: Collects scan.ascii and scan.nxs
note over PI: 5 months later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to scan.ascii and scan.nxs
note over PI: 1 year later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to scan.nxs
    </pre></details>
<details>
<summary>1 Bluesky scan, one neutron run</summary>
<pre  class="mermaid">
        sequenceDiagram
actor PI
participant NDX
participant Archive
participant TopCat
note over PI:Start of RBNumber experiment
PI -&gt;&gt; NDX: Start bluesky scan
note over NDX: Bluesky scan starts DAE run
note over PI: Time Passes
note over NDX: Bluesky scan ends DAE run &lt;br/&gt; Bluesky scan ends
par
note over NDX: creates runnumber.nxs with DAE and SE data
and
note over NDX: creates scan.ascii and scan.nxs
end
NDX -&gt;&gt; Archive: Sends runnumber.nxs, scan.ascii, and scan.nxs
TopCat -&gt;&gt; Archive: Collects runnumber.nxs, scan.ascii, and scan.nxs
note over PI: 5 months later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to runnumber.nxs, scan.ascii, and scan.nxs
note over PI: 1 year later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to runnumber.nxs and scan.nxs
    </pre></details>
<details>
<summary>1 Bluesky scan, N neutron runs</summary>
<pre  class="mermaid">
        sequenceDiagram
actor PI
participant NDX
participant Archive
participant TopCat
note over PI:Start of RBNumber experiment
PI -&gt;&gt; NDX: Start bluesky scan
note over NDX: Bluesky scan starts DAE run
note over PI: Time Passes
note over NDX: Bluesky scan ends DAE run
note over NDX: creates runnumber.nxs with DAE and SE data
NDX -&gt;&gt; Archive: Sends runnumber.nxs
TopCat -&gt;&gt; Archive: Collects runnumber.nxs
note over PI: Time Passes
note over NDX: Bluesky scan starts DAE run
note over PI: Time Passes
note over NDX: Bluesky scan ends DAE run
note over NDX: creates runnumber+1.nxs with DAE and SE data
NDX -&gt;&gt; Archive: Sends runnumber+1.nxs
TopCat -&gt;&gt; Archive: Collects runnumber+1.nxs
note over NDX: Bluesky scan ends
NDX -&gt;&gt; Archive: Sends scan.ascii and scan.nxs
TopCat -&gt;&gt; Archive: Collects scan.ascii and scan.nxs
note over PI: 5 months later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to runnumber.nxs, runnumber+1.nxs, scan.ascii, and scan.nxs
note over PI: 1 year later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to runnumber.nxs, runnumber+1.nxs, and scan.nxs
    </pre></details>
<details>
<summary>1 Bluesky scan, neutron/muon runs on multiple instruments</summary>
<pre  class="mermaid">
        sequenceDiagram
actor PI
participant NDX-A
participant NDX-B
participant NDX-C
participant Archive
participant TopCat
note over PI:Start of RBNumber experiment
PI -&gt;&gt; NDX-A: Start bluesky scan
NDX-A -&gt;&gt; NDX-B: Start DAE run
NDX-A -&gt;&gt; NDX-C: Start DAE run
note over PI: Time Passes
NDX-B -&gt;&gt; NDX-A: Provides summary run data
NDX-C -&gt;&gt; NDX-A: Provides summary run data
NDX-A -&gt;&gt; NDX-B: End DAE run
note over NDX-B: creates runnumberB.nxs with DAE and SE data
NDX-B -&gt;&gt; Archive: Sends runnumberB.nxs
TopCat -&gt;&gt; Archive: Collects runnumberB.nxs
NDX-A -&gt;&gt; NDX-C: End DAE run
note over NDX-C: creates runnumberC.nxs with DAE and SE data
NDX-C -&gt;&gt; Archive: Sends runnumberC.nxs
TopCat -&gt;&gt; Archive: Collects runnumberC.nxs
note over NDX-A: Bluesky scan ends
NDX-A -&gt;&gt; Archive: Sends scan.ascii and scan.nxs
TopCat -&gt;&gt; Archive: Collects scan.ascii and scan.nxs
note over PI: 5 months later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to runnumberB.nxs, runnumberC.nxs, scan.ascii, and scan.nxs
note over PI: 1 year later
PI -&gt;&gt; TopCat: Show me my data
TopCat -&gt;&gt; PI: Provides access to runnumberB.nxs, runnumberC.nxs, and scan.nxs
    </pre></details>
</section>
<section id="present">
<h2>Present<a class="headerlink" href="#present" title="Link to this heading"></a></h2>
<p>The following people have been involved in discussions leading up to this ADR:</p>
<ul class="simple">
<li><p>Tom</p></li>
<li><p>Chris M-S</p></li>
<li><p>George</p></li>
<li><p>Kathryn</p></li>
<li><p>Jack H</p></li>
<li><p>CK (Reflectometry)</p></li>
</ul>
<p>This document was additionally reviewed:</p>
<ul class="simple">
<li><p>In a regular Thursday code-review slot by the whole IBEX team.</p></li>
<li><p>In a regular scans library catch-up meeting, including RD (SANS), CK (Reflectometry), JL (Muons)</p></li>
</ul>
</section>
<section id="decisions">
<h2>Decisions<a class="headerlink" href="#decisions" title="Link to this heading"></a></h2>
<section id="file-writing-location">
<h3>File-writing location<a class="headerlink" href="#file-writing-location" title="Link to this heading"></a></h3>
<p>Bluesky should write data into the <code class="docutils literal notranslate"><span class="pre">c:\data\RB&lt;rb_number&gt;\bluesky_scans\</span></code> folder during a scan.
File naming itself will keep its current scheme (timestamped files).</p>
<p>This location was chosen because it mirrors the archiving setup used by neutron cameras on IMAT.</p>
</section>
<section id="attributes-checksums">
<h3>Attributes &amp; checksums<a class="headerlink" href="#attributes-checksums" title="Link to this heading"></a></h3>
<p>Bluesky should mark files as read-only, using Windows file attributes, when it has finished writing them. This is so
that the archiving process can unambiguously tell whether a file has finished being written. It also reduces the
likelihood that a file is accidentally modified.</p>
<p>Checksums should be generated, either at the point when the data is initially generated, or by the archiving process
just before it first copies or moves a file.</p>
<p>We have agreed on the desire to generate checksums for data, which is already done for DAE data. These checksums are
useful to check for data corruption, which might occur in transit, or in-place on instrument computers or archive servers.
A number of checksumming approaches have been considered, and no approach has been chosen yet. The options discussed
are:</p>
<ul class="simple">
<li><p><strong>Use windows alternate file streams</strong>. This is how checksums are done in existing DAE <code class="docutils literal notranslate"><span class="pre">.raw</span></code> files. It has the
advantage that it is relatively simple to implement, but the disadvantage that they do not map nicely onto Linux file
systems.</p></li>
<li><p><strong>Generate one checksum per file</strong>, for example <code class="docutils literal notranslate"><span class="pre">file.txt</span></code> would also have an associated <code class="docutils literal notranslate"><span class="pre">file.sha1.txt</span></code> containing the
checksum. The advantage is that this is simple to implement and platform-agnostic. The disadvantage is that it doubles
the number of files visible in the archive area.</p></li>
<li><p><strong>Generate a single checksum file</strong> containing the checksums of all bluesky data, at a higher level of granularity (for
example by RB number or by cycle). It is currently unclear exactly how this approach would be implemented, and at what
point these checksums would be moved to the archive.</p></li>
</ul>
</section>
<section id="moving-to-the-isis-archive">
<h3>Moving to the ISIS archive<a class="headerlink" href="#moving-to-the-isis-archive" title="Link to this heading"></a></h3>
<p>An automated cron task will look for read-only Bluesky output files, and their associated checksums, in <code class="docutils literal notranslate"><span class="pre">c:\data</span></code> at
regular short intervals (for example, 1 minute), and will move them to:</p>
<ul class="simple">
<li><p>The ISIS data archive, under <code class="docutils literal notranslate"><span class="pre">autoreduced/bluesky_scans</span></code>. The <code class="docutils literal notranslate"><span class="pre">autoreduced</span></code> folder already exists on the archive.</p></li>
<li><p>The data cache disk on the instrument, under <code class="docutils literal notranslate"><span class="pre">c:\data\Export</span> <span class="pre">only\RB&lt;rb_number\bluesky_scans</span></code>.</p></li>
</ul>
<p>Data on the cache disk, under <code class="docutils literal notranslate"><span class="pre">Export</span> <span class="pre">only</span></code>, is kept on the instrument for a short period (usually 24 hours), and then
deleted by existing processes.</p>
<p>This is run as a cron task so that, if the network happens to be unavailable at the time when a scan ends, the copy
process will catch up when the network becomes available again. This cron task will only move files which sit within
a <code class="docutils literal notranslate"><span class="pre">bluesky_scans</span></code> folder, to prevent it from interfering with other non-bluesky files.</p>
<p>Creating a new <code class="docutils literal notranslate"><span class="pre">bluesky_scans</span></code> folder alongside the existing <code class="docutils literal notranslate"><span class="pre">autoreduced</span></code> folder was considered, but was felt to be
unachievable - it would require too much work relative to using the existing <code class="docutils literal notranslate"><span class="pre">autoreduced</span></code> folder.</p>
</section>
<section id="file-formats">
<h3>File formats<a class="headerlink" href="#file-formats" title="Link to this heading"></a></h3>
<p>At present, our scan file output format is explicitly designed to be “human-readable” (and, in fact, the callback which
generates these files is explicitly called
<a class="reference internal" href="../generated/ibex_bluesky_core.callbacks.html#ibex_bluesky_core.callbacks.HumanReadableFileCallback" title="ibex_bluesky_core.callbacks.HumanReadableFileCallback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">HumanReadableFileCallback</span></code></a>).</p>
<p>We have <a class="reference external" href="https://github.com/ISISComputingGroup/ibex_bluesky_core/issues/26">issue 26</a> which will implement
machine-readable files, using a format such as <code class="docutils literal notranslate"><span class="pre">.hdf5</span></code> or <code class="docutils literal notranslate"><span class="pre">.nxs</span></code>. These files will sit alongside the existing
human-readable files; it is acknowledged that while machine-readable files are better from a data preservation and
archiving standpoint, we will need to retain the human-readable files to support quick browsing by scientists without
using special software.</p>
</section>
</section>
<section id="consequences">
<h2>Consequences<a class="headerlink" href="#consequences" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Bluesky output data will be stored in a location suitable for long-term, scientifically useful, data. This includes
data integrity and availability concerns.</p></li>
<li><p>Bluesky scans will no longer be reliant on a network location being available to run a scan</p></li>
<li><p>The initial location where bluesky writes data (<code class="docutils literal notranslate"><span class="pre">c:\data\&lt;rb</span> <span class="pre">number&gt;</span></code>) will not be the same as its final location (the
<code class="docutils literal notranslate"><span class="pre">autoreduced</span></code> folder on the ISIS archive). This is also true for current DAE data, as generated by the ISISICP.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="006-where-to-put-code.html" class="btn btn-neutral float-left" title="6. Where to put code" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="008-centre-of-mass.html" class="btn btn-neutral float-right" title="8. Using our own Centre of Mass Callback" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>